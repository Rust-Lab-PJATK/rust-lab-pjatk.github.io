<!DOCTYPE html>
<html lang="pl" >

<head>
    <meta charset="UTF-8"><meta http-equiv="Content-Security-Policy"
content="default-src 'self';font-src &#x27;self&#x27; data: 'self';img-src &#x27;self&#x27; https:&#x2F;&#x2F;* data:;media-src &#x27;self&#x27;;style-src &#x27;self&#x27; 'unsafe-inline';frame-src player.vimeo.com https:&#x2F;&#x2F;www.youtube-nocookie.com;connect-src 'self';script-src 'self' 'self'">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="base" content="https://rust-lab-pjatk.github.io">

    
    <title>Rust Lab PJATK ‚Ä¢ Implementacja serwera us≈Çugi Pigen na bazie protoko≈Çu TCP</title>

    
    
    
        <link rel=icon href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="50%" x="50%" dominant-baseline="central" text-anchor="middle" font-size="88">ü¶Ä</text></svg>'>
    

    
    

    
    
    
        
            <link rel="stylesheet" href="https://rust-lab-pjatk.github.io/custom_subset.css?h=0b9535a28bc3d5bf2321">
        
    

    
        <link rel="stylesheet" href="https://rust-lab-pjatk.github.io/main.css?h=5761abda13287149cf75" />
        <link rel="stylesheet" href="https://rust-lab-pjatk.github.io/skins/pjatk.css?h=14166792eb0b5e4e3507" />

    <meta name="color-scheme" content="light dark" />
        <meta name="theme-color" content="#e30613" />
        <meta name="description" content="Dowiedz siƒô jak napisaƒá wielowƒÖtkowy serwer obliczajƒÖcy kolejne cyfry liczby pi, wykorzystujƒÖc protok√≥≈Ç TCP i biblioteki do obs≈Çugi puli wƒÖtk√≥w oraz du≈ºych liczb ca≈Çkowitych." />
        <meta property="og:description" content="Dowiedz siƒô jak napisaƒá wielowƒÖtkowy serwer obliczajƒÖcy kolejne cyfry liczby pi, wykorzystujƒÖc protok√≥≈Ç TCP i biblioteki do obs≈Çugi puli wƒÖtk√≥w oraz du≈ºych liczb ca≈Çkowitych." />

    

    <meta property="og:title" content="Implementacja serwera us≈Çugi Pigen na bazie protoko≈Çu TCP" />
    <meta property="og:type" content="article" />

    
<meta property="og:locale" content="pl_PL" />

    <meta property="og:url" content="https:&#x2F;&#x2F;rust-lab-pjatk.github.io&#x2F;blog&#x2F;implementacja-serwera-pigen-tcp&#x2F;" /><meta property="og:site_name" content="Rust Lab PJATK">
        <noscript><link rel="stylesheet" href="https://rust-lab-pjatk.github.io/no_js.css"/></noscript>
        <script type="text/javascript" src="https://rust-lab-pjatk.github.io/js/initializeTheme.min.js"></script>
        <script defer src="https://rust-lab-pjatk.github.io/js/themeSwitcher.min.js"></script></head>


<body>
    <header>
    <nav class="navbar">
        <div class="nav-title">
            <a class="home-title" href="https://rust-lab-pjatk.github.io">Rust Lab PJATK</a>
        </div>
            <div class="nav-navs">
                <ul>
                        
                            <li>
                                <a class="nav-links no-hover-padding" href="https://rust-lab-pjatk.github.io/blog/">Blog
                                </a>
                            </li>
                        
                            <li>
                                <a class="nav-links no-hover-padding" href="https://rust-lab-pjatk.github.io/tags/">Tagi
                                </a>
                            </li>
                        
                            <li>
                                <a class="nav-links no-hover-padding" href="https://rust-lab-pjatk.github.io/archiwum/">Archiwum
                                </a>
                            </li>
                        <li class="menu-icons-container">
                        <ul class="menu-icons-group">
                            

                            
                            

                            <li class="theme-switcher-wrapper js"><div
        title="Prze≈ÇƒÖcz ciemny&#x2F;jasny motyw"
        class="theme-switcher"
        tabindex="0"
        role="button"
        aria-label="Prze≈ÇƒÖcz ciemny motyw"
        aria-pressed="false">
    </div><div
        title="Przywr√≥ƒá domy≈õlny motyw"
        class="theme-resetter arrow"
        tabindex="0"
        role="button"
        aria-hidden="true"
        aria-label="Przywr√≥ƒá domy≈õlny motyw">
    </div>

</li>
</ul>
                    </li>
                </ul>
            </div>
        
    </nav>
</header>

    <div class="content">

        
        




<main>
    <article>
        <h1 class="article-title">
            Implementacja serwera us≈Çugi Pigen na bazie protoko≈Çu TCP
        </h1>

        <ul class="meta"><li>Autorzy: Maciej Pƒôdzich</li>
                <li><span class='separator' aria-hidden='true'>‚Ä¢</span>15 mar 2025</li><li title="S≈Çowa: 1940"><span class='separator' aria-hidden='true'>‚Ä¢</span>Czas czytania (w minutach): 10</li><li class="tag"><span class='separator' aria-hidden='true'>‚Ä¢</span>Tagi:&nbsp;</li><li class="tag"><a href="https://rust-lab-pjatk.github.io/tags/miniprojekt/">miniprojekt</a>,&nbsp;</li><li class="tag"><a href="https://rust-lab-pjatk.github.io/tags/sieci/">sieci</a></li>
        </ul>
            

<div class="toc-container">
    
        <h3>Spis tre≈õci</h3>
    

    <ul>
        
            
            
                <li><a href="https://rust-lab-pjatk.github.io/blog/implementacja-serwera-pigen-tcp/#specyfikacja-protokolu-i-moje-zmiany">Specyfikacja protoko≈Çu i moje zmiany</a>
                    
                </li>
            
        
            
            
                <li><a href="https://rust-lab-pjatk.github.io/blog/implementacja-serwera-pigen-tcp/#algorytm-na-obliczanie-kolejnych-cyfr-liczby-pi">Algorytm na obliczanie kolejnych cyfr liczby pi</a>
                    
                </li>
            
        
            
            
                <li><a href="https://rust-lab-pjatk.github.io/blog/implementacja-serwera-pigen-tcp/#zewnetrzne-biblioteki">Zewnƒôtrzne biblioteki</a>
                    
                        <ul>
                            
                                
                                    <li><a href="https://rust-lab-pjatk.github.io/blog/implementacja-serwera-pigen-tcp/#threadpool-mechanizm-puli-watkow">threadpool - mechanizm puli wƒÖtk√≥w</a>
                                        
                                    </li>
                                
                            
                                
                                    <li><a href="https://rust-lab-pjatk.github.io/blog/implementacja-serwera-pigen-tcp/#rug-duze-liczby-calkowite">rug - du≈ºe liczby ca≈Çkowite</a>
                                        
                                    </li>
                                
                            
                        </ul>
                    
                </li>
            
        
            
            
                <li><a href="https://rust-lab-pjatk.github.io/blog/implementacja-serwera-pigen-tcp/#analiza-kodu">Analiza kodu</a>
                    
                        <ul>
                            
                                
                                    <li><a href="https://rust-lab-pjatk.github.io/blog/implementacja-serwera-pigen-tcp/#inicjalizacja-serwera-i-puli-watkow">Inicjalizacja serwera i puli wƒÖtk√≥w</a>
                                        
                                    </li>
                                
                            
                                
                                    <li><a href="https://rust-lab-pjatk.github.io/blog/implementacja-serwera-pigen-tcp/#nasluchiwanie-polaczen-i-uruchamianie-kolejkowanie-watkow">Nas≈Çuchiwanie po≈ÇƒÖcze≈Ñ i uruchamianie&#x2F;kolejkowanie wƒÖtk√≥w</a>
                                        
                                    </li>
                                
                            
                                
                                    <li><a href="https://rust-lab-pjatk.github.io/blog/implementacja-serwera-pigen-tcp/#implementacja-algorytmu-na-obliczanie-kolejnych-cyfr-pi">Implementacja algorytmu na obliczanie kolejnych cyfr pi</a>
                                        
                                    </li>
                                
                            
                        </ul>
                    
                </li>
            
        
            
            
                <li><a href="https://rust-lab-pjatk.github.io/blog/implementacja-serwera-pigen-tcp/#podsumowanie">Podsumowanie</a>
                    
                </li>
            
        
    </ul>
</div>


        

        <section class="body"><p>Witaj, ≈õwiecie!</p>
<p>Z okazji niedawno minionego <a href="https://www.piday.org">dnia liczby pi</a>, chcia≈Çbym przedstawiƒá m√≥j projekt serwera (nieco zmodyfikowanej) us≈Çugi Pigen opisanej w <a href="https://datatracker.ietf.org/doc/html/rfc3091">dokumencie IETF RFC 3091</a> oraz wyja≈õniƒá stojƒÖcy za nim algorytm do obliczania kolejnych cyfr tej liczby.</p>
<p><a href="https://github.com/Rust-Lab-PJATK/pigen-tcp">Kod ≈∫r√≥d≈Çowy znajdziesz tutaj</a>.</p>
<h2 id="specyfikacja-protokolu-i-moje-zmiany"><a class="header-anchor no-hover-padding" href="#specyfikacja-protokolu-i-moje-zmiany" aria-label="Anchor link for: specyfikacja-protokolu-i-moje-zmiany"><span class="link-icon" aria-hidden="true"></span></a>
Specyfikacja protoko≈Çu i moje zmiany</h2>
<p>Specyfikacja Pigen w oparciu o protok√≥≈Ç transportowy TCP ma bardzo proste wymagania:</p>
<ol>
<li>Serwer nas≈Çuchuje na porcie numer 314159.</li>
<li>Po nawiƒÖzaniu po≈ÇƒÖczenia z klientem, serwer wysy≈Ça strumieniowo kolejne cyfry liczby œÄ w systemie dziesiƒôtnym i kodowaniu ASCII, poczƒÖwszy od pierwszej cyfry po przecinku, a≈º do momentu roz≈ÇƒÖczenia siƒô przez klienta.</li>
</ol>
<p>Wprowadzi≈Çem dwie drobne zmiany:</p>
<ol>
<li>Serwer nas≈Çuchuje na porcie numer <strong>31415</strong>, poniewa≈º najwiƒôkszy mo≈ºliwy numer portu TCP wynosi 65535 (wyb√≥r portu 314159 by≈Ç najpewniej niedopatrzeniem ze strony autora oryginalnego dokumentu).</li>
<li>[...] serwer wysy≈Ça kolejne cyfry liczby œÄ (w celu zmniejszenia obciƒÖ≈ºenia sieci) [...], poczƒÖwszy od <strong>cyfry jedno≈õci</strong> [...], gdy≈º u≈Çatwia to implementacjƒô oraz wyt≈Çumaczenie dzia≈Çania zastosowanego przeze mnie algorytmu.</li>
</ol>
<p>Specyfikacja nie narzuca konkretnej metody generowania cyfr. Choƒá m√≥g≈Çbym wykorzystaƒá <a href="http://newton.ex.ac.uk/research/qsystems/collabs/pi/pi6.txt">plik z milionem cyfr</a> i wysy≈Çaƒá jego zawarto≈õƒá, takie rozwiƒÖzanie by≈Çoby zbyt proste i ma≈Ço interesujƒÖce. Co wiƒôcej, nie spe≈Çnia ono potrzeb klient√≥w ≈ºƒÖdnych miliona jeden, miliona dw√≥ch, czy miliona trzech pierwszych cyfr (o milionie czterech nie wspominajƒÖc).</p>
<h2 id="algorytm-na-obliczanie-kolejnych-cyfr-liczby-pi"><a class="header-anchor no-hover-padding" href="#algorytm-na-obliczanie-kolejnych-cyfr-liczby-pi" aria-label="Anchor link for: algorytm-na-obliczanie-kolejnych-cyfr-liczby-pi"><span class="link-icon" aria-hidden="true"></span></a>
Algorytm na obliczanie kolejnych cyfr liczby pi</h2>
<p>Zdecydowanie ciekawsze i bardziej elastyczne podej≈õcie stanowi zaprogramowanie algorytmu, kt√≥ry potrafi obliczyƒá œÄ z dowolnie du≈ºƒÖ precyzjƒÖ, gdzie jedynymi ograniczeniami sƒÖ dostƒôpna moc obliczeniowa i pamiƒôƒá.</p>
<p>Z pomocƒÖ przychodzi wz√≥r podany po raz pierwszy w XVII wieku przez <a href="https://en.wikipedia.org/wiki/William_Brouncker,_2nd_Viscount_Brouncker">Williama Brouncker'a</a>, kt√≥ry przedstawia ƒáwierƒá œÄ jako <a href="https://pl.wikipedia.org/wiki/U%C5%82amek_%C5%82a%C5%84cuchowy">u≈Çamek ≈Ça≈Ñcuchowy</a>:</p>
<p>$$\dfrac \pi 4 = \dfrac 1 {1 + \cfrac {1^2} {2 + \cfrac {3^2} {2 + \cfrac {5^2} {2 + \cfrac {7^2} {2 + \cdots } } } } }$$</p>
<p>Jak zauwa≈ºy≈Ç L. J. Lange w <a href="https://www.jstor.org/stable/2589152">artykule <em>An Elegant Continued Fraction for œÄ</em></a>, przy <a href="https://proofwiki.org/wiki/Brouncker%27s_Formula">dowodzeniu prawdziwo≈õci powy≈ºszego wzoru</a> mo≈ºna wykorzystaƒá alternatywnƒÖ formƒô u≈Çamka ≈Ça≈Ñcuchowego dla g≈Ç√≥wnej krzywej rozga≈Çƒôzienia funkcji $\arctan(z)$ w p≈Çaszczy≈∫nie liczb zespolonych, gdzie $z$ nie znajduje siƒô na osi urojonej ani od $-i$ poni≈ºej, ani od $i$ wzwy≈º:</p>
<p>$$\arctan(z) = \frac {z} {1+{\cfrac {(1z)^{2} } {3+{\cfrac {(2z)^{2} } { 5+{\cfrac {(3z)^{2} } {7+{\cfrac {(4z)^{2} } {9+\cdots } } } } } } } } }$$</p>
<p>PodstawiajƒÖc 1 za $z$ oraz mno≈ºƒÖc obie strony r√≥wno≈õci razy 4, otrzymamy:</p>
<p>$$\pi = \frac {4} {1+{\cfrac {1^2} {3+{\cfrac {2^2} { 5+{\cfrac {3^2} {7+{\cfrac {4^2} {9+\cdots } } } } } } } } }$$</p>
<p>W tej formie, ka≈ºdy kolejny zagnie≈ºd≈ºony u≈Çamek wynosi $\frac { k^2 } { 2k + 1 + \cdots } $ dla $k \in \natnums$, gdzie $\cdots$ oznacza sumƒô pozosta≈Çych u≈Çamk√≥w tej postaci od $k + 1$ do $\infty$.</p>
<p>Tym sposobem dochodzimy wreszcie do algorytmu opracowanego przez autor√≥w <a href="https://homepages.cwi.nl/~steven/abc/programmers/handbook.html">podrƒôcznika jƒôzyka programowania ABC</a> (rozdzia≈Ç <em>Examples of ABC</em>, podrozdzia≈Ç <em>Numbers</em>), kt√≥ry polega na obliczaniu dw√≥ch kolejnych przybli≈ºe≈Ñ, poczƒÖwszy od $\frac 4 1$ oraz $\frac 4 {1 + \frac 1 3 }$ (czyli $\frac {12} 4$) i sprawdzeniu r√≥wno≈õci ich kolejnych cyfr w rozwiniƒôciu dziesiƒôtnym.</p>
<p>Je≈õli na danej pozycji znajduje siƒô ta sama cyfra, wysy≈Çamy jƒÖ do klienta i sprawdzamy r√≥wno≈õƒá cyfr na kolejnej pozycji. W przeciwnym razie, obliczamy kolejny u≈Çamek w ≈Ça≈Ñcuchu (w tej iteracji $\frac 4 {1 + \frac 1 { 3 + \frac 4 5 } }$), po czym wykonujemy sprawdzenie zgodno≈õci wiodƒÖcych cyfr z $\frac 4 {1 + \frac 1 3 }$, dƒÖ≈ºƒÖc tym samym do coraz wiƒôkszej dok≈Çadno≈õci z ka≈ºdym nastƒôpnym $k$.</p>
<h2 id="zewnetrzne-biblioteki"><a class="header-anchor no-hover-padding" href="#zewnetrzne-biblioteki" aria-label="Anchor link for: zewnetrzne-biblioteki"><span class="link-icon" aria-hidden="true"></span></a>
Zewnƒôtrzne biblioteki</h2>
<p>Zanim przejdziemy do <em>czƒô≈õci praktycznej</em> tego artyku≈Çu, musimy jeszcze poruszyƒá dwie kwestie zwiƒÖzane z projektem serwera Pigen.</p>
<h3 id="threadpool-mechanizm-puli-watkow"><a class="header-anchor no-hover-padding" href="#threadpool-mechanizm-puli-watkow" aria-label="Anchor link for: threadpool-mechanizm-puli-watkow"><span class="link-icon" aria-hidden="true"></span></a>
<code>threadpool</code> - mechanizm puli wƒÖtk√≥w</h3>
<p>PierwszƒÖ z nich jest obs≈Çuga wielu klient√≥w jednocze≈õnie. Poniewa≈º mamy do czynienia z us≈ÇugƒÖ, kt√≥ra k≈Çadzie wiƒôkszy nacisk na moc obliczeniowƒÖ serwera ni≈º przepustowo≈õƒá sieci, zdecydowa≈Çem siƒô na wykorzystanie tradycyjnych wƒÖtk√≥w systemowych zamiast modelu <code>async/await</code>.</p>
<p>Oczywi≈õcie, tworzenie nowego wƒÖtku za ka≈ºdym razem gdy zostanie nawiƒÖzane po≈ÇƒÖczenie to prosty przepis na nieszczƒô≈õcie. Wystarczy, ≈ºe kto≈õ uruchomi skrypt, kt√≥ry w niesko≈Ñczonej pƒôtli bƒôdzie otwiera≈Ç nowe po≈ÇƒÖczenia, ≈ºeby nie tylko nasz program, ale te≈º ca≈Çe urzƒÖdzenie pad≈Ço na kolana.</p>
<p>Bardziej rozsƒÖdnym podej≈õciem jest tworzenie ograniczonej liczby wƒÖtk√≥w do obs≈Çugi po≈ÇƒÖcze≈Ñ. W przypadku gdy zostanie ona osiƒÖgniƒôta, a nowy klient bƒôdzie chcia≈Ç nawiƒÖzaƒá z nami po≈ÇƒÖczenie, wystarczy go poinformowaƒá o pe≈Çnym obciƒÖ≈ºeniu i zakolejkowaƒá jego ≈ºƒÖdanie. Kiedy inny klient siƒô roz≈ÇƒÖczy, bƒôdziemy mogli w√≥wczas obs≈Çu≈ºyƒá klienta oczekujƒÖcego w kolejce.</p>
<p>Choƒá m√≥g≈Çbym siƒô pokusiƒá o napisanie <a href="https://buraksekili.github.io/articles/thread-pooling-rs">w≈Çasnego mechanizmu puli wƒÖtk√≥w</a>, postanowi≈Çem siƒôgnƒÖƒá po <a href="https://crates.io/crates/threadpool">bibliotekƒô <code>threadpool</code></a>, by skupiƒá siƒô na wcze≈õniej opisanym algorytmie. Skoro zn√≥w o nim mowa, czas przej≈õƒá do drugiego problemu.</p>
<h3 id="rug-duze-liczby-calkowite"><a class="header-anchor no-hover-padding" href="#rug-duze-liczby-calkowite" aria-label="Anchor link for: rug-duze-liczby-calkowite"><span class="link-icon" aria-hidden="true"></span></a>
<code>rug</code> - du≈ºe liczby ca≈Çkowite</h3>
<p>Podstawowe typy liczb ca≈Çkowitych w jƒôzyku Rust majƒÖ pojemno≈õƒá ograniczonƒÖ do konkretnej liczby bajt√≥w. Dla zdecydowanej wiƒôkszo≈õci program√≥w dany zakres jest wystarczajƒÖco du≈ºy by przechowywaƒá dane i wykonywaƒá na nich obliczenia bez obaw o przekroczenie maksymalnej dopuszczalnej warto≈õci.</p>
<p>Niestety, nawet 64-bitowa liczba ca≈Çkowita bez znaku (kt√≥ra potrafi zmie≈õciƒá <a href="https://doc.rust-lang.org/std/primitive.u64.html#associatedconstant.MAX">ponad 18 trylion√≥w</a>), okazuje siƒô dla u≈ºytego przeze mnie algorytmu zbyt ma≈Ça do obliczenia... dziesiƒÖtej cyfry po przecinku. Nic jednak dziwnego, gdy≈º ten algorytm zosta≈Ç napisany z my≈õlƒÖ o jƒôzyku ABC, kt√≥rego typ liczby ca≈Çkowitej ma (teoretycznie) nieograniczonƒÖ pojemno≈õƒá.</p>
<p>Ma≈Ço tego, w niekt√≥rych jƒôzykach <em>g≈Ç√≥wnego nurtu</em> takich jak <a href="https://docs.python.org/3/library/stdtypes.html#numeric-types-int-float-complex">Python</a> czy <a href="https://ruby-doc.com/docs/ProgrammingRuby/html/tut_stdtypes.html">Ruby</a>, liczby ca≈Çkowite r√≥wnie≈º sƒÖ (lub mogƒÖ byƒá w razie potrzeby) przechowywane w formie potrafiƒÖcej pomie≈õciƒá dowolnie du≈ºƒÖ warto≈õƒá. Z kolei w jƒôzykach pokroju <a href="https://docs.oracle.com/javase/8/docs/api/java/math/BigInteger.html">Javy</a> albo <a href="https://learn.microsoft.com/pl-pl/dotnet/api/system.numerics.biginteger?view=net-9.0">C#'a</a>, dostƒôpny jest oddzielny typ do reprezentowania <em>niesko≈Ñczenie wielkich</em> liczb ca≈Çkowitych.</p>
<p>O ile Rust nie posiada wbudowanego w jƒôzyk rozwiƒÖzania w stylu ostatnich dw√≥ch ze wcze≈õniej wspomnianych jƒôzyk√≥w, tak na ratunek przychodzi spo≈Çeczno≈õƒá z <a href="https://crates.io/crates/rug">bibliotekƒÖ <code>rug</code></a>, kt√≥ra dostarcza wysokopoziomowy interfejs programistyczny dla <a href="https://gmplib.org">GNU Multiple Precision Arithmetic Library</a>.</p>
<p>Skrzynka <code>rug</code> jest udostƒôpniana na licencji <a href="https://www.gnu.org/licenses/lgpl-3.0.en.html">GNU <strong>Lesser</strong> General Public License v3</a>, co powinno u≈Çatwiƒá jej integracjƒô z komercyjnymi projektami. Je≈õli mimo to jej licencja nadal jest nieodpowiednia, polecam zapoznaƒá siƒô z zamiennikiem w postaci <a href="https://lib.rs/crates/num-bigint">biblioteki <code>num-bigint</code></a>.</p>
<h2 id="analiza-kodu"><a class="header-anchor no-hover-padding" href="#analiza-kodu" aria-label="Anchor link for: analiza-kodu"><span class="link-icon" aria-hidden="true"></span></a>
Analiza kodu</h2>
<p>Po tym obszernym wstƒôpie mo≈ºemy w ko≈Ñcu przej≈õƒá do analizy kodu serwera.</p>
<h3 id="inicjalizacja-serwera-i-puli-watkow"><a class="header-anchor no-hover-padding" href="#inicjalizacja-serwera-i-puli-watkow" aria-label="Anchor link for: inicjalizacja-serwera-i-puli-watkow"><span class="link-icon" aria-hidden="true"></span></a>
Inicjalizacja serwera i puli wƒÖtk√≥w</h3>
<p>Zacznijmy od zaimportowania potrzebnych nam cech/interfejs√≥w i struktur oraz utworzenia ich instancji:</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">rug<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>Assign<span class="z-punctuation z-separator z-rust">,</span> Integer</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust"><span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">std<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">error<span class="z-punctuation z-accessor z-rust">::</span></span>Error<span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust"><span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">std<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">io<span class="z-punctuation z-accessor z-rust">::</span></span>Write<span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust"><span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">std<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">net<span class="z-punctuation z-accessor z-rust">::</span></span>TcpListener<span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust"><span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">threadpool<span class="z-punctuation z-accessor z-rust">::</span></span>ThreadPool<span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">main</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-&gt;</span> <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Result</span><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-punctuation z-section z-group z-end z-rust">)</span>, <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Box</span><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span>dyn Error<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span></span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> pool <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">ThreadPool<span class="z-punctuation z-accessor z-rust">::</span></span>new<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-constant z-numeric z-integer z-decimal z-rust">5</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> listener <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">TcpListener<span class="z-punctuation z-accessor z-rust">::</span></span>bind<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&quot;</span>0.0.0.0:31415<span class="z-punctuation z-definition z-string z-end z-rust">&quot;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-keyword z-operator z-rust">?</span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-support z-type z-rust">Ok</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p>Wykorzysta≈Çem <a href="https://doc.rust-lang.org/rust-by-example/error/result.html#using-result-in-main">alternatywnƒÖ sygnaturƒô funkcji <code>main</code></a>, aby m√≥c pos≈Çugiwaƒá siƒô <a href="https://doc.rust-lang.org/rust-by-example/std/result/question_mark.html">operatorem <code>?</code></a> do wy≈Çuskiwania pomy≈õlnych wynik√≥w zamiast potencjalnie panikujƒÖcych wywo≈Ça≈Ñ <a href="https://doc.rust-lang.org/std/result/enum.Result.html#method.unwrap"><code>unwrap()</code></a>. W razie wystƒÖpienia wyjƒÖtku, ten zostanie wy≈õwietlony w postaci <a href="https://doc.rust-lang.org/std/fmt/trait.Debug.html"><code>Debug</code></a>, a proces zako≈Ñczy siƒô z kodem b≈Çƒôdu. Natomiast podstawienie <a href="https://doc.rust-lang.org/std/boxed/index.html"><code>Box&lt;dyn Error&gt;</code></a> jako spodziewany typ b≈Çƒôdu umo≈ºliwia zwracanie obiektu dowolnego typu, pod warunkiem ≈ºe implementuje <a href="https://doc.rust-lang.org/std/error/trait.Error.html">cechƒô <code>Error</code></a>.</p>
<p>Co do liczby wƒÖtk√≥w w puli, 5 nie jest w ≈ºaden spos√≥b wiƒÖ≈ºƒÖcƒÖ czy najbardziej optymalnƒÖ liczbƒÖ. Mo≈ºna dowolnie eksperymentowaƒá z jej zwiƒôkszaniem lub zmniejszaniem w zale≈ºno≈õci od wymaganej liczby klient√≥w do r√≥wnoleg≈Çego obs≈Çugiwania oraz mocy obliczeniowej serwera.</p>
<h3 id="nasluchiwanie-polaczen-i-uruchamianie-kolejkowanie-watkow"><a class="header-anchor no-hover-padding" href="#nasluchiwanie-polaczen-i-uruchamianie-kolejkowanie-watkow" aria-label="Anchor link for: nasluchiwanie-polaczen-i-uruchamianie-kolejkowanie-watkow"><span class="link-icon" aria-hidden="true"></span></a>
Nas≈Çuchiwanie po≈ÇƒÖcze≈Ñ i uruchamianie/kolejkowanie wƒÖtk√≥w</h3>
<p>Mamy zadeklarowany nas≈Çuchiwacz, wiƒôc pora na obs≈Çugƒô przychodzƒÖcych po≈ÇƒÖcze≈Ñ. Je≈õli dysponujemy wolnym wƒÖtkiem, mo≈ºemy natychmiastowo rozpoczƒÖƒá generowanie cyfr œÄ dla klienta. W przeciwnym razie musimy go poinformowaƒá, ≈ºe serwer osiƒÖgnƒÖ≈Ç limit obs≈Çugiwanych jednocze≈õnie po≈ÇƒÖcze≈Ñ i zakolejkowaƒá ≈ºƒÖdanie.</p>
<p>W tym celu nale≈ºy dodaƒá poni≈ºszy kawa≈Çek kodu miƒôdzy deklaracjƒÖ zmiennej <code>listener</code>, a zwr√≥ceniem warto≈õci <code>Ok(())</code>:</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-keyword z-control z-rust">for</span> <span class="z-storage z-modifier z-rust">mut</span> stream <span class="z-keyword z-operator z-rust">in</span> listener<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">incoming</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">flatten</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">    <span class="z-keyword z-control z-rust">if</span> pool<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">active_count</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-comparison z-rust">==</span> pool<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">max_count</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        stream<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">write_all</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-storage z-type z-string z-rust">b</span><span class="z-punctuation z-definition z-string z-begin z-rust">&quot;</span>Serwer jest zajƒôty! Proszƒô czekaƒá...<span class="z-constant z-character z-escape z-rust">\n</span><span class="z-punctuation z-definition z-string z-end z-rust">&quot;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-keyword z-operator z-rust">?</span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">    pool<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">execute</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-storage z-modifier z-rust">move</span> <span class="z-keyword z-operator z-logical z-rust">||</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust">        <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> cdn.
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></code></pre>
<p><a href="https://doc.rust-lang.org/std/net/struct.TcpListener.html#method.incoming">Metoda <code>incoming()</code></a> zwraca iterator, kt√≥ry w niesko≈Ñczonej pƒôtli akceptuje przychodzƒÖce po≈ÇƒÖczenia, a ka≈ºdy element jest <a href="https://doc.rust-lang.org/std/io/type.Result.html">typu <code>io::Result</code></a>, kt√≥rego pomy≈õlnym wynikiem jest <a href="https://doc.rust-lang.org/std/net/struct.TcpStream.html">obiekt reprezentujƒÖcy strumie≈Ñ TCP</a>. Z kolei <a href="https://doc.rust-lang.org/std/iter/trait.Iterator.html#method.flatten">metoda <code>flatten()</code></a> pozwala nam wy≈Çuskaƒá wspomniany strumie≈Ñ z element√≥w iteratora, kt√≥re sƒÖ pomy≈õlnymi wynikami, a opr√≥cz tego pominƒÖƒá wszystkie wyniki wariantu pora≈ºki.</p>
<p>Pomimo tego, ≈ºe wykonujemy sprawdzenie r√≥wno≈õci obecnej liczby aktywnych wƒÖtk√≥w i ich maksymalnej dopuszczalnej liczby, zar√≥wno uruchamianie jak i kolejkowanie wƒÖtk√≥w odbywa siƒô poprzez wywo≈Çanie <a href="https://docs.rs/threadpool/1.8.1/threadpool/struct.ThreadPool.html#method.execute">metody <code>execute()</code> puli wƒÖtk√≥w</a>. Pula zadba o uruchomienie pierwszego w kolejce wƒÖtku kiedy inny wƒÖtek zako≈Ñczy pracƒô.</p>
<p>Poniewa≈º bƒôdziemy odwo≈Çywaƒá siƒô wewnƒÖtrz wƒÖtku do obiektu <code>stream</code>, nale≈ºy pamiƒôtaƒá o umieszczeniu s≈Çowa kluczowego <code>move</code> przed definicjƒÖ domkniƒôcia. Istnieje bowiem szansa, ≈ºe wƒÖtek <em>poboczny</em> bƒôdzie aktywny d≈Çu≈ºej ni≈º ten, kt√≥ry go uruchomi≈Ç. StƒÖd te≈º wymagane jest, by wszelkie dane u≈ºywane w nowym wƒÖtku mia≈Çy czas ≈ºycia r√≥wny <code>'static</code>, czyli ≈ºeby by≈Çy dostƒôpne a≈º do ko≈Ñca dzia≈Çania wƒÖtku.</p>
<p>Domy≈õlnie <code>stream</code> zosta≈Çby jedynie po≈ºyczony, a skoro nie mamy gwarancji, ≈ºe jego czas ≈ºycia bƒôdzie co najmniej r√≥wny czasowi trwania wƒÖtku, to przy pr√≥bie u≈ºycia <code>stream</code> w domkniƒôciu bez <code>move</code> otrzymamy <a href="https://doc.rust-lang.org/error_codes/E0373.html">b≈ÇƒÖd kompilacji</a>. Zatem domkniƒôcie musi przejƒÖƒá <code>stream</code> na w≈Çasno≈õƒá w celu spe≈Çnienia powy≈ºszego wymagania.</p>
<h3 id="implementacja-algorytmu-na-obliczanie-kolejnych-cyfr-pi"><a class="header-anchor no-hover-padding" href="#implementacja-algorytmu-na-obliczanie-kolejnych-cyfr-pi" aria-label="Anchor link for: implementacja-algorytmu-na-obliczanie-kolejnych-cyfr-pi"><span class="link-icon" aria-hidden="true"></span></a>
Implementacja algorytmu na obliczanie kolejnych cyfr pi</h3>
<p>Czas na gw√≥d≈∫ programu. Zaczynamy wewnƒÖtrz domkniƒôcia od deklaracji zmiennych dla $k$ oraz dw√≥ch kolejnych przybli≈ºe≈Ñ œÄ:</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> k <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">Integer<span class="z-punctuation z-accessor z-rust">::</span></span>from<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-constant z-numeric z-integer z-decimal z-rust">2</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust"><span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> a <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">Integer<span class="z-punctuation z-accessor z-rust">::</span></span>from<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-constant z-numeric z-integer z-decimal z-rust">4</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust"><span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> b <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">Integer<span class="z-punctuation z-accessor z-rust">::</span></span>from<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-constant z-numeric z-integer z-decimal z-rust">1</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust"><span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> a1 <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">Integer<span class="z-punctuation z-accessor z-rust">::</span></span>from<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-constant z-numeric z-integer z-decimal z-rust">12</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust"><span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> b1 <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">Integer<span class="z-punctuation z-accessor z-rust">::</span></span>from<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-constant z-numeric z-integer z-decimal z-rust">4</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></code></pre>
<p>Zmienne <code>a</code> i <code>a1</code> oznaczajƒÖ liczniki, za≈õ <code>b</code> i <code>b1</code> mianowniki odpowiednich przybli≈ºe≈Ñ. Nastƒôpnie rozpoczynamy niesko≈ÑczonƒÖ pƒôtlƒô z etykietƒÖ <code>'pi</code>, na poczƒÖtku kt√≥rej obliczamy $k$-ty u≈Çamek w serii i odpowiednio zwiƒôkszamy <code>a1</code> i <code>b1</code>, by uzyskaƒá $k$-te przybli≈ºenie œÄ. Poprzednie warto≈õci tych zmiennych przypisujemy do <code>a</code> i <code>b</code> oraz zwiƒôkszamy $k$ o 1.</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-entity z-name z-label z-rust">&#39;pi</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-control z-rust">loop</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> p <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">Integer<span class="z-punctuation z-accessor z-rust">::</span></span>from<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&amp;</span>k <span class="z-keyword z-operator z-arithmetic z-rust">*</span> <span class="z-keyword z-operator z-bitwise z-rust">&amp;</span>k</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> q <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">Integer<span class="z-punctuation z-accessor z-rust">::</span></span>from<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-constant z-numeric z-integer z-decimal z-rust">2</span> <span class="z-keyword z-operator z-arithmetic z-rust">*</span> <span class="z-keyword z-operator z-bitwise z-rust">&amp;</span>k</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-arithmetic z-rust">+</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">1</span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> prev_a1 <span class="z-keyword z-operator z-assignment z-rust">=</span> a1<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">clone</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> prev_b1 <span class="z-keyword z-operator z-assignment z-rust">=</span> b1<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">clone</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">    k <span class="z-keyword z-operator z-assignment z-rust">+=</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">1</span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">    a1 <span class="z-keyword z-operator z-assignment z-rust">*=</span> <span class="z-keyword z-operator z-bitwise z-rust">&amp;</span>q<span class="z-punctuation z-terminator z-rust">;</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">    a1 <span class="z-keyword z-operator z-assignment z-rust">+=</span> <span class="z-keyword z-operator z-bitwise z-rust">&amp;</span>p <span class="z-keyword z-operator z-arithmetic z-rust">*</span> <span class="z-keyword z-operator z-bitwise z-rust">&amp;</span>a<span class="z-punctuation z-terminator z-rust">;</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">    b1 <span class="z-keyword z-operator z-assignment z-rust">*=</span> <span class="z-keyword z-operator z-bitwise z-rust">&amp;</span>q<span class="z-punctuation z-terminator z-rust">;</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">    b1 <span class="z-keyword z-operator z-assignment z-rust">+=</span> <span class="z-keyword z-operator z-bitwise z-rust">&amp;</span>p <span class="z-keyword z-operator z-arithmetic z-rust">*</span> <span class="z-keyword z-operator z-bitwise z-rust">&amp;</span>b<span class="z-punctuation z-terminator z-rust">;</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">    a <span class="z-keyword z-operator z-assignment z-rust">=</span> prev_a1<span class="z-punctuation z-terminator z-rust">;</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">    b <span class="z-keyword z-operator z-assignment z-rust">=</span> prev_b1<span class="z-punctuation z-terminator z-rust">;</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></code></pre>
<p>Warto zwr√≥ciƒá uwagƒô chocia≈ºby na formƒô deklaracji zmiennych <code>p</code> i <code>q</code> oraz na rozbicie poszczeg√≥lnych operacji na <code>a1</code> i <code>b1</code> zamiast jednego wiƒôkszego wyra≈ºenia lub operacji przypisania jak w oryginalnej implementacji algorytmu w jƒôzyku ABC. Wynika to ze zwracania przez <code>rug</code> <a href="https://docs.rs/rug/1.27.0/rug/index.html#incomplete-computation-values"><em>niepe≈Çnego wyniku oblicze≈Ñ</em></a> dla dzia≈Ça≈Ñ na dw√≥ch obiektach <code>Integer</code> zamiast nowego obiektu tego samego typu.</p>
<p>Takie zachowanie pozwala zmniejszyƒá liczbƒô kosztownych operacji alokacji pamiƒôci wykonywanych przez te obiekty, chocia≈ºby poprzez przypisywanie tych wynik√≥w do istniejƒÖcych obiekt√≥w z pomocƒÖ przeciƒÖ≈ºonych operator√≥w albo <a href="https://docs.rs/rug/1.27.0/rug/struct.Integer.html#impl-Assign-for-Integer">metody <code>assign()</code></a>. Je≈õli jednak nie ma innego wyj≈õcia ni≈º utworzenie nowej liczby typu <code>Integer</code>, to mo≈ºemy przekazaƒá wynik do <code>Integer::from</code> tak samo jak robili≈õmy to ze <em>zwyk≈Çymi</em> liczbami.</p>
<p>Zosta≈Ço nam ju≈º tylko wyciƒÖganie i por√≥wnywanie kolejnych cyfr z rozwiniƒôƒá dziesiƒôtnych przybli≈ºe≈Ñ œÄ Jesli cyfra na danej pozycji jest taka sama dla obu u≈Çamk√≥w, mo≈ºemy jƒÖ wys≈Çaƒá do klienta. W razie gdy jej przes≈Çanie siƒô nie powiedzie (najpewniej z powodu zerwania po≈ÇƒÖczenia przez klienta), przerywamy pƒôtlƒô <code>'pi</code> i tym samym ko≈Ñczymy wƒÖtek. Je≈õli cyfry siƒô r√≥≈ºniƒÖ, to oznacza, ≈ºe czas na obliczenie kolejnego przybli≈ºenia œÄ.</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> d <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">Integer<span class="z-punctuation z-accessor z-rust">::</span></span>from<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&amp;</span>a <span class="z-keyword z-operator z-arithmetic z-rust">/</span> <span class="z-keyword z-operator z-bitwise z-rust">&amp;</span>b</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust"><span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> d1 <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">Integer<span class="z-punctuation z-accessor z-rust">::</span></span>from<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&amp;</span>a1 <span class="z-keyword z-operator z-arithmetic z-rust">/</span> <span class="z-keyword z-operator z-bitwise z-rust">&amp;</span>b1</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-keyword z-control z-rust">while</span> d <span class="z-keyword z-operator z-comparison z-rust">==</span> d1 <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> ascii_d <span class="z-keyword z-operator z-assignment z-rust">=</span> d<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">to_string</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">    <span class="z-keyword z-control z-rust">if</span> <span class="z-storage z-type z-rust">let</span> <span class="z-support z-type z-rust">Err</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>_e</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-assignment z-rust">=</span> stream<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">write_all</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>ascii_d<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">as_ref</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        <span class="z-keyword z-control z-rust">break</span> <span class="z-storage z-modifier z-lifetime z-rust">&#39;pi</span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">    a <span class="z-keyword z-operator z-assignment z-rust">%=</span> <span class="z-keyword z-operator z-bitwise z-rust">&amp;</span>b<span class="z-punctuation z-terminator z-rust">;</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">    a <span class="z-keyword z-operator z-assignment z-rust">*=</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">10</span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">    a1 <span class="z-keyword z-operator z-assignment z-rust">%=</span> <span class="z-keyword z-operator z-bitwise z-rust">&amp;</span>b1<span class="z-punctuation z-terminator z-rust">;</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">    a1 <span class="z-keyword z-operator z-assignment z-rust">*=</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">10</span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">    d<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">assign</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&amp;</span>a <span class="z-keyword z-operator z-arithmetic z-rust">/</span> <span class="z-keyword z-operator z-bitwise z-rust">&amp;</span>b</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">    d1<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">assign</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&amp;</span>a1 <span class="z-keyword z-operator z-arithmetic z-rust">/</span> <span class="z-keyword z-operator z-bitwise z-rust">&amp;</span>b1</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></code></pre>
<p>Warto zauwa≈ºyƒá, ≈ºe nie musimy dokonywaƒá konwersji ≈Ça≈Ñcucha <code>ascii_d</code> na opakowywany przez niego wektor bajt√≥w. Typ <code>String</code> implementuje <a href="https://doc.rust-lang.org/std/convert/trait.AsRef.html">cechƒô <code>AsRef</code></a> do pobierania referencji na wycinek bajt√≥w (<code>&amp;[u8]</code>) zamiast <code>&amp;String</code>, kiedy <a href="https://doc.rust-lang.org/std/io/trait.Write.html#method.write_all">metoda <code>write_all()</code></a> wymaga dostarczenia danych do wys≈Çania w formie <code>&amp;[u8]</code>.</p>
<h2 id="podsumowanie"><a class="header-anchor no-hover-padding" href="#podsumowanie" aria-label="Anchor link for: podsumowanie"><span class="link-icon" aria-hidden="true"></span></a>
Podsumowanie</h2>
<p>Serwer jest gotowy! Teraz wystarczy go uruchomiƒá i przetestowaƒá np. za pomocƒÖ klienta og√≥lnego u≈ºytku jak <a href="https://nmap.org/ncat"><code>ncat</code></a>:</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">ncat</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>recv-only</span> WSTAW_TU_IP_SERWERA 31415</span>
</span></code></pre>
<p>Oczywi≈õcie, temu projektowi daleko do miana rekordzisty prƒôdko≈õci, a samych sposob√≥w na wyznaczanie kolejnych cyfr liczby œÄ jest znacznie wiƒôcej. Moim celem by≈Ço zaprezentowanie paru przydatnych bibliotek oraz wyja≈õnienie ca≈Çkiem prostego w implementacji aglorytmu, co mam nadziejƒô uda≈Ço mi siƒô osiƒÖgnƒÖƒá.</p>
<p>Zachƒôcam do poeksperymentowania z innymi algorytmami, rozbijaniem samych oblicze≈Ñ na wiele wƒÖtk√≥w, czy napisania od podstaw serwera us≈Çugi Pigen w oparciu o <a href="https://datatracker.ietf.org/doc/html/rfc3091#autoid-3">protok√≥≈Ç UDP</a>.</p>
<p>Do zobaczenia w kolejnym artykule!</p>

        </section>

        
        
        

        
            
            
            

            
        
            
            
            

            
        
            
            
            

            
        
            
            
            

            
        
        

    </article>
</main>

    <div id="button-container">
        
        
            <div id="toc-floating-container">
                <input type="checkbox" id="toc-toggle" class="toggle"/>
                <label for="toc-toggle" class="overlay"></label>
                <label for="toc-toggle" id="toc-button" class="button" title="Prze≈ÇƒÖcz spis tre≈õƒá">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960"><path d="M414.82-193.094q-18.044 0-30.497-12.32-12.453-12.319-12.453-30.036t12.453-30.086q12.453-12.37 30.497-12.37h392.767q17.237 0 29.927 12.487 12.69 12.486 12.69 30.203 0 17.716-12.69 29.919t-29.927 12.203H414.82Zm0-244.833q-18.044 0-30.497-12.487Q371.87-462.9 371.87-480.45t12.453-29.92q12.453-12.369 30.497-12.369h392.767q17.237 0 29.927 12.511 12.69 12.512 12.69 29.845 0 17.716-12.69 30.086-12.69 12.37-29.927 12.37H414.82Zm0-245.167q-18.044 0-30.497-12.32t-12.453-30.037q0-17.716 12.453-30.086 12.453-12.369 30.497-12.369h392.767q17.237 0 29.927 12.486 12.69 12.487 12.69 30.203 0 17.717-12.69 29.92-12.69 12.203-29.927 12.203H414.82ZM189.379-156.681q-32.652 0-55.878-22.829t-23.226-55.731q0-32.549 23.15-55.647 23.151-23.097 55.95-23.097 32.799 0 55.313 23.484 22.515 23.484 22.515 56.246 0 32.212-22.861 54.893-22.861 22.681-54.963 22.681Zm0-245.167q-32.652 0-55.878-23.134-23.226-23.135-23.226-55.623 0-32.487 23.467-55.517t56.12-23.03q32.102 0 54.721 23.288 22.62 23.288 22.62 55.775 0 32.488-22.861 55.364-22.861 22.877-54.963 22.877Zm-.82-244.833q-32.224 0-55.254-23.288-23.03-23.289-23.03-55.623 0-32.333 23.271-55.364 23.272-23.03 55.495-23.03 32.224 0 55.193 23.288 22.969 23.289 22.969 55.622 0 32.334-23.21 55.364-23.21 23.031-55.434 23.031Z"/></svg>
                </label>
                <div class="toc-content">
                    

<div class="toc-container">
    

    <ul>
        
            
            
                <li><a href="https://rust-lab-pjatk.github.io/blog/implementacja-serwera-pigen-tcp/#specyfikacja-protokolu-i-moje-zmiany">Specyfikacja protoko≈Çu i moje zmiany</a>
                    
                </li>
            
        
            
            
                <li><a href="https://rust-lab-pjatk.github.io/blog/implementacja-serwera-pigen-tcp/#algorytm-na-obliczanie-kolejnych-cyfr-liczby-pi">Algorytm na obliczanie kolejnych cyfr liczby pi</a>
                    
                </li>
            
        
            
            
                <li><a href="https://rust-lab-pjatk.github.io/blog/implementacja-serwera-pigen-tcp/#zewnetrzne-biblioteki">Zewnƒôtrzne biblioteki</a>
                    
                        <ul>
                            
                                
                                    <li><a href="https://rust-lab-pjatk.github.io/blog/implementacja-serwera-pigen-tcp/#threadpool-mechanizm-puli-watkow">threadpool - mechanizm puli wƒÖtk√≥w</a>
                                        
                                    </li>
                                
                            
                                
                                    <li><a href="https://rust-lab-pjatk.github.io/blog/implementacja-serwera-pigen-tcp/#rug-duze-liczby-calkowite">rug - du≈ºe liczby ca≈Çkowite</a>
                                        
                                    </li>
                                
                            
                        </ul>
                    
                </li>
            
        
            
            
                <li><a href="https://rust-lab-pjatk.github.io/blog/implementacja-serwera-pigen-tcp/#analiza-kodu">Analiza kodu</a>
                    
                        <ul>
                            
                                
                                    <li><a href="https://rust-lab-pjatk.github.io/blog/implementacja-serwera-pigen-tcp/#inicjalizacja-serwera-i-puli-watkow">Inicjalizacja serwera i puli wƒÖtk√≥w</a>
                                        
                                    </li>
                                
                            
                                
                                    <li><a href="https://rust-lab-pjatk.github.io/blog/implementacja-serwera-pigen-tcp/#nasluchiwanie-polaczen-i-uruchamianie-kolejkowanie-watkow">Nas≈Çuchiwanie po≈ÇƒÖcze≈Ñ i uruchamianie&#x2F;kolejkowanie wƒÖtk√≥w</a>
                                        
                                    </li>
                                
                            
                                
                                    <li><a href="https://rust-lab-pjatk.github.io/blog/implementacja-serwera-pigen-tcp/#implementacja-algorytmu-na-obliczanie-kolejnych-cyfr-pi">Implementacja algorytmu na obliczanie kolejnych cyfr pi</a>
                                        
                                    </li>
                                
                            
                        </ul>
                    
                </li>
            
        
            
            
                <li><a href="https://rust-lab-pjatk.github.io/blog/implementacja-serwera-pigen-tcp/#podsumowanie">Podsumowanie</a>
                    
                </li>
            
        
    </ul>
</div>


                </div>
            </div>
        

        
        

        
        <a href="#" id="top-button" class="no-hover-padding" title="Przejd≈∫ na poczƒÖtek strony">
            <svg viewBox="0 0 20 20" fill="currentColor"><path d="M3.293 9.707a1 1 0 010-1.414l6-6a1 1 0 011.414 0l6 6a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L4.707 9.707a1 1 0 01-1.414 0z"/></svg>
        </a>
    </div>


<link rel="stylesheet" href="https://rust-lab-pjatk.github.io/katex.min.css">
    <script defer src="https://rust-lab-pjatk.github.io/js/katex.min.js"></script><script defer src="https://rust-lab-pjatk.github.io/js/mermaid.min.js"></script><span id="copy-success" class="hidden">
        Skopiowano!
    </span>
    <span id="copy-init" class="hidden">
        Skopiuj kod do schowka
    </span>
    <script defer src="https://rust-lab-pjatk.github.io/js/copyCodeToClipboard.min.js"></script>


    </div>
    <footer>
    <section>
        <nav class="socials nav-navs"><ul>
                        
                            <li>
                                <a class="nav-links no-hover-padding social" rel=" me"  href="mailto:rustlab@pjwstk.edu.pl">
                                    <img loading="lazy" alt="email" title="email" src="https://rust-lab-pjatk.github.io/social_icons/email.svg">
                                </a>
                            </li>
                        
                            <li>
                                <a class="nav-links no-hover-padding social" rel=" me"  href="https://github.com/Rust-Lab-PJATK">
                                    <img loading="lazy" alt="github" title="github" src="https://rust-lab-pjatk.github.io/social_icons/github.svg">
                                </a>
                            </li>
                        
                            <li>
                                <a class="nav-links no-hover-padding social" rel=" me"  href="https://www.linkedin.com/company/rust-lab-pjatk">
                                    <img loading="lazy" alt="linkedin" title="linkedin" src="https://rust-lab-pjatk.github.io/social_icons/linkedin.svg">
                                </a>
                            </li>
                        
                            <li>
                                <a class="nav-links no-hover-padding social" rel=" me"  href="https://www.instagram.com/rustlabpjatk">
                                    <img loading="lazy" alt="instagram" title="instagram" src="https://rust-lab-pjatk.github.io/social_icons/instagram.svg">
                                </a>
                            </li>
                        
                    
                </ul>
            
        </nav>

        
        <nav class="nav-navs">
        </nav>

        <div class="credits">
            <small>
                
    
    
    
    
        
    
        
    

    

    
    
    

    
    
    <p><p>¬© 2025 Rust Lab PJATK ‚Ä¢ Materia≈Çy na tej stronie sƒÖ udostƒôpniane na licencji <a href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA 4.0</a>.</p>
</p>

                
                Strona oparta na oprogramowaniu
                <a rel=""  href="https://www.getzola.org">Zola</a>
                i
                <a rel=""  href="https://github.com/welpo/tabi">tabi</a>

                </small>
        </div>
    </section>

    </footer>

</body>

</html>
